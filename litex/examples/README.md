
# Two registers example

This example shows how to assign a 32-bit register to another in a migen module
and debug the result with the wishbone-bus.


``` python

class TwoRegModule(Module, AutoCSR):
    def __init__(self):
        self.foo = CSRStorage(32)
        self.bar = CSRStorage(32)
        # We store it into sync, the memory access is synchronous
        # i.e. it needs a clock.
        self.sync += self.bar.storage.eq(self.foo.storage)

```

This instantiates our Migen module. 
With the wishbone tool it's possible to query CSR locations.

The addresses can be found inside `build/csr.csv` generated by migen.

``` text
#--------------------------------------------------------------------------------
# Auto-generated by Migen (562c046) & LiteX (f0b5c672) on 2020-02-07 17:45:09
#--------------------------------------------------------------------------------
csr_base,timer0,0x60002800,,
csr_base,two_reg_mod,0x60003000,,
csr_register,timer0_reload,0x60002810,4,rw
csr_register,timer0_load,0x60002800,4,rw
csr_register,two_reg_mod_bar,0x60003010,4,rw
csr_register,timer0_update_value,0x60002824,1,rw
csr_register,timer0_value,0x60002828,4,ro
csr_register,timer0_en,0x60002820,1,rw
csr_register,timer0_ev_status,0x60002838,1,rw
csr_register,two_reg_mod_foo,0x60003000,4,rw
csr_register,timer0_ev_pending,0x6000283c,1,rw
csr_register,timer0_ev_enable,0x60002840,1,rw
constant,config_cpu_type,none,,
constant,config_shadow_base,2147483648,,
constant,config_csr_alignment,32,,
constant,config_clock_frequency,12000000,,
constant,config_cpu_type_none,None,,
constant,config_csr_data_width,8,,
memory_region,csr,0x60000000,65536,cached
memory_region,sram,0x10000000,131072,cached
```

In our case, we can write in the 32 bit register foo and try to read
the same value in bar.

To write to foo:

``` shell
wishbone-tool 0x60003000 0x4
```
and then read from bar:

``` shell
wishbone-tool 0x60003010
```

Inheriting from AutoCSR allows to automatically map the CSR registers to be
mem_mapped to valid wishbone virtual addresses.

## Storing more than 8-bits and wishbone addresses.

In the current default implementation, the base soc instantiates:
- A wishbone master `DummyUsb` that takes care of the comms between USB
channels and the wishbone bus (if the debug flag is enabled) see
https://github.com/litex-hub/litex-boards/blob/master/litex_boards/targets/fomu.py#L218.
- A wishbone slave converted to a csr_bus master used to read/write values and
all the related CSR locations as either reg or memory(sram) registers.


The default granularity of the csr_bus master is 8 bits as you can see [here][13].

For the reasons above, it's not possible to store or read more than 8 bits. 
A way to do that, is to exploit "fields" as it's done [here][1]. In this way we can
map multiple 8 bit registers to multiple mapped wishbone addresses.

As you can see [here][12], the last two bits are completely ignored.

This means that querying `wishbone-tool 0x60003000`, `wishbone-tool 0x60003001`,
`wishbone-tool 0x60003002`, `wishbone-tool 0x60003003` will return the same value. 

# Useful Pointers

* [CSRStorage with multiple fields][1]
* [Fomu Hacker Platform Definition][2]
* [Fomu Hacker Target (BaseSoc)][3]
* [Fo-boot][4]
* [What is buildenv][5]
* [HDMI2USB interesting project][6]
* [Wishbone Interconnect definition][7]
* [List of interconnects of litex][8]
* [SocCore definition][9]
* [Wishbone interface definition][10]
* [UP5K SPRAM definition][11]
* [Valenty usb wishbone address Interpretation][12]
* [Default csr_bus interface width][13]

[1]: https://github.com/im-tomu/foboot/blob/57f7a8bb95eec058efe2a748f46d3fd44983b3d0/hw/rtl/picorvspi.py#L13-L17
[2]: https://github.com/litex-hub/litex-boards/blob/master/litex_boards/platforms/fomu_hacker.py
[3]: https://github.com/litex-hub/litex-boards/blob/master/litex_boards/targets/fomu.py#L218 
[4]: https://github.com/im-tomu/foboot/blob/57f7a8bb95eec058efe2a748f46d3fd44983b3d0/hw/foboot-bitstream.py
[5]: https://github.com/timvideos/litex-buildenv/wiki
[6]: https://github.com/timvideos/HDMI2USB-litex-firmware/blob/master/targets/ice40_up5k_b_evn/base.py
[7]: https://github.com/enjoy-digital/litex/blob/master/litex/soc/interconnect/wishbone.py
[8]: https://github.com/enjoy-digital/litex/tree/1dced8183e2daf2edf7f921793929131b4ba600f/litex/soc/interconnect
[9]: https://github.com/enjoy-digital/litex/blob/master/litex/soc/integration/soc_core.py
[10]: https://github.com/enjoy-digital/litex/blob/1dced8183e2daf2edf7f921793929131b4ba600f/litex/soc/interconnect/wishbone.py#L35
[11]: https://github.com/enjoy-digital/litex/blob/master/litex/soc/cores/up5kspram.py#L24
[12]: https://github.com/im-tomu/valentyusb/blob/a0526ad053c394306ad7a585a7ddd463831ad09d/valentyusb/usbcore/cpu/usbwishbonebridge.py#L249
[13]: https://github.com/enjoy-digital/litex/blob/1dced8183e2daf2edf7f921793929131b4ba600f/litex/soc/interconnect/csr_bus.py#L35
